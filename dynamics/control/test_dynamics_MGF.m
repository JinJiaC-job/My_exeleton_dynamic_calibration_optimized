%% test_dynamics_MGF.m
%  计算状态空间方程中的质量矩阵、重力矢量、摩擦项

clear, clc, close all;
% P_link = evalin('base', 'P_link');
load('.\utils\gen_params\P_link.mat', 'P_link');
load('.\data\mat\dyn_inertia_link_jointAxis.mat');
q1 = q(1); q2 = q(2); q3 = q(3); q4 = q(4); q5 = q(5); q6 = q(6);
qd1 = qd(1); qd2 = qd(2); qd3 = qd(3); qd4 = qd(4); qd5 = qd(5); qd6 = qd(6);
qdd1 = qdd(1); qdd2 = qdd(2); qdd3 = qdd(3); qdd4 = qdd(4); qdd5 = qdd(5); qdd6 = qdd(6);
%% 导入运动学参数
d2 = -188.76; d3 = -81.24; d5 = -12.15; d6 = 112;
a5 = 252.5; alp4 = 4/9*pi; g = 9802;%单位：mm
fe1 = 0; fe2 = 0; fe3 = 0; ne1 = 0; ne2 = 0; ne3 = 0;

%% 导入动力学参数
P_link = P_link/1000;

m1 = P_link(1); 
m2 = P_link(14); 
m3 = P_link(27); 
m4 = P_link(40); 
m5 = P_link(53); 
m6 = P_link(66); 

mc11 = P_link(2) /m1; mc12 = P_link(3) /m1; mc13 = P_link(4) /m1;
mc21 = P_link(15)/m2; mc22 = P_link(16)/m2; mc23 = P_link(17)/m2;
mc31 = P_link(28)/m3; mc32 = P_link(29)/m3; mc33 = P_link(30)/m3;
mc41 = P_link(41)/m4; mc42 = P_link(42)/m4; mc43 = P_link(43)/m4;
mc51 = P_link(54)/m5; mc52 = P_link(55)/m5; mc53 = P_link(56)/m5;
mc61 = P_link(67)/m6; mc62 = P_link(68)/m6; mc63 = P_link(69)/m6;

Io111 = P_link(5) ; Io122 = P_link(6) ; Io133 = P_link(7) ; Io112 = P_link(8) ; Io113 = P_link(9) ; Io123 = P_link(10);
Io211 = P_link(18); Io222 = P_link(19); Io233 = P_link(20); Io212 = P_link(21); Io213 = P_link(22); Io223 = P_link(23);
Io311 = P_link(31); Io322 = P_link(32); Io333 = P_link(33); Io312 = P_link(34); Io313 = P_link(35); Io323 = P_link(36);
Io411 = P_link(44); Io422 = P_link(45); Io433 = P_link(46); Io412 = P_link(47); Io413 = P_link(48); Io423 = P_link(49);
Io511 = P_link(57); Io522 = P_link(58); Io533 = P_link(59); Io512 = P_link(60); Io513 = P_link(61); Io523 = P_link(62);
Io611 = P_link(70); Io622 = P_link(71); Io633 = P_link(72); Io612 = P_link(73); Io613 = P_link(74); Io623 = P_link(75);

Ia1 = P_link(11);
Ia2 = P_link(24);
Ia3 = P_link(37);
Ia4 = P_link(50);
Ia5 = P_link(63);
Ia6 = P_link(76);

fv1 = P_link(12); fc1 = P_link(13); 
fv2 = P_link(25); fc2 = P_link(26); 
fv3 = P_link(38); fc3 = P_link(39); 
fv4 = P_link(51); fc4 = P_link(52); 
fv5 = P_link(64); fc5 = P_link(65); 
fv6 = P_link(77); fc6 = P_link(78); 
%% 计算各关节扭矩
TT = sym(zeros(6, 1));
for k = 1:6
    TT(k) = eval(subs(tau(k), ...
                 {'m1', 'C1x', 'C1y', 'C1z', 'Ioxx1', 'Ioxy1', 'Ioxz1', 'Ioyy1', 'Ioyz1', 'Iozz1', 'Ia1', 'fv1', 'fc1', ...
                  'm2', 'C2x', 'C2y', 'C2z', 'Ioxx2', 'Ioxy2', 'Ioxz2', 'Ioyy2', 'Ioyz2', 'Iozz2', 'Ia2', 'fv2', 'fc2', ...
                  'm3', 'C3x', 'C3y', 'C3z', 'Ioxx3', 'Ioxy3', 'Ioxz3', 'Ioyy3', 'Ioyz3', 'Iozz3', 'Ia3', 'fv3', 'fc3', ...
                  'm4', 'C4x', 'C4y', 'C4z', 'Ioxx4', 'Ioxy4', 'Ioxz4', 'Ioyy4', 'Ioyz4', 'Iozz4', 'Ia4', 'fv4', 'fc4', ...
                  'm5', 'C5x', 'C5y', 'C5z', 'Ioxx5', 'Ioxy5', 'Ioxz5', 'Ioyy5', 'Ioyz5', 'Iozz5', 'Ia5', 'fv5', 'fc5', ...
                  'm6', 'C6x', 'C6y', 'C6z', 'Ioxx6', 'Ioxy6', 'Ioxz6', 'Ioyy6', 'Ioyz6', 'Iozz6', 'Ia6', 'fv6', 'fc6', ...
...                   'q1', 'q2', 'q3', 'q4', 'q5', 'q6', ...
...					  'qd1', 'qd2', 'qd3', 'qd4', 'qd5', 'qd6', ...
...					  'qdd1', 'qdd2', 'qdd3', 'qdd4', 'qdd5', 'qdd6', ...
				  'fe1', 'fe2', 'fe3',  'ne1', 'ne2', 'ne3', ...
				  'g', 'd2', 'd3', 'd5', 'd6', 'a5', 'alp4'}, ...
				  {m1, mc11, mc12, mc13, Io111, Io122, Io133, Io112, Io113, Io123, Ia1, fv1, fc1, ...
				   m2, mc21, mc22, mc23, Io211, Io222, Io233, Io212, Io213, Io223, Ia2, fv2, fc2, ...
				   m3, mc31, mc32, mc33, Io311, Io322, Io333, Io312, Io313, Io323, Ia3, fv3, fc3, ...
				   m4, mc41, mc42, mc43, Io411, Io422, Io433, Io412, Io413, Io423, Ia4, fv4, fc4, ...
				   m5, mc51, mc52, mc53, Io511, Io522, Io533, Io512, Io513, Io523, Ia5, fv5, fc5, ...
				   m6, mc61, mc62, mc63, Io611, Io622, Io633, Io612, Io613, Io623, Ia6, fv6, fc6, ...
...					   q(1), q(2), q(3), q(4), q(5), q(6), ...
...					   qd(1), qd(2), qd(3), qd(4), qd(5) qd(6), ...
...					   qdd(1), qdd(2), qdd(3), qdd(4), qdd(5), qdd(6), ...
				   fe1, fe2, fe3, ne1, ne2, ne3, ...
				   g, d2, d3, d5, d6, a5, alp4}));
end
disp('<INFO> Full Torque SUBSTITUTED!!');

%% 惯性矩阵
M = dynamics_Mfunc(tau);
MM = sym(zeros(6, 6));
for i = 1:6
    for j = 1:6
    MM(i, j) = eval(subs(M(i, j), ...
                 {'m1', 'C1x', 'C1y', 'C1z', 'Ioxx1', 'Ioxy1', 'Ioxz1', 'Ioyy1', 'Ioyz1', 'Iozz1', 'Ia1', 'fv1', 'fc1', ...
                  'm2', 'C2x', 'C2y', 'C2z', 'Ioxx2', 'Ioxy2', 'Ioxz2', 'Ioyy2', 'Ioyz2', 'Iozz2', 'Ia2', 'fv2', 'fc2', ...
                  'm3', 'C3x', 'C3y', 'C3z', 'Ioxx3', 'Ioxy3', 'Ioxz3', 'Ioyy3', 'Ioyz3', 'Iozz3', 'Ia3', 'fv3', 'fc3', ...
                  'm4', 'C4x', 'C4y', 'C4z', 'Ioxx4', 'Ioxy4', 'Ioxz4', 'Ioyy4', 'Ioyz4', 'Iozz4', 'Ia4', 'fv4', 'fc4', ...
                  'm5', 'C5x', 'C5y', 'C5z', 'Ioxx5', 'Ioxy5', 'Ioxz5', 'Ioyy5', 'Ioyz5', 'Iozz5', 'Ia5', 'fv5', 'fc5', ...
                  'm6', 'C6x', 'C6y', 'C6z', 'Ioxx6', 'Ioxy6', 'Ioxz6', 'Ioyy6', 'Ioyz6', 'Iozz6', 'Ia6', 'fv6', 'fc6', ...
...                     'q1', 'q2', 'q3', 'q4', 'q5', 'q6', ...
... 					'qd1', 'qd2', 'qd3', 'qd4', 'qd5', 'qd6', ...
... 					'qdd1', 'qdd2', 'qdd3', 'qdd4', 'qdd5', 'qdd6', ...
				  'fe1', 'fe2', 'fe3',  'ne1', 'ne2', 'ne3', ...
				  'g', 'd2', 'd3', 'd5', 'd6', 'a5', 'alp4'}, ...
				  {m1, mc11, mc12, mc13, Io111, Io122, Io133, Io112, Io113, Io123, Ia1, fv1, fc1, ...
				   m2, mc21, mc22, mc23, Io211, Io222, Io233, Io212, Io213, Io223, Ia2, fv2, fc2, ...
				   m3, mc31, mc32, mc33, Io311, Io322, Io333, Io312, Io313, Io323, Ia3, fv3, fc3, ...
				   m4, mc41, mc42, mc43, Io411, Io422, Io433, Io412, Io413, Io423, Ia4, fv4, fc4, ...
				   m5, mc51, mc52, mc53, Io511, Io522, Io533, Io512, Io513, Io523, Ia5, fv5, fc5, ...
				   m6, mc61, mc62, mc63, Io611, Io622, Io633, Io612, Io613, Io623, Ia6, fv6, fc6, ...
... 					   q1, q2, q3, q4, q5, q6, ...
... 					   qd1, qd2, qd3, qd4, qd5, qd6, ...
... 					   qdd1, qdd2, qdd3, qdd4, qdd5, qdd6, ...
				   fe1, fe2, fe3, ne1, ne2, ne3, ...
				   g, d2, d3, d5, d6, a5, alp4}));
    end
end
disp('<INFO> Inertial Matrix SUBSTITUTED!!');

%% 重力矩
G = dynamics_Gfunc(tau);
GG = sym(zeros(6, 1));
for k = 1:6
    GG(k) = eval(subs(G(k), ...
                 {'m1', 'C1x', 'C1y', 'C1z', 'Ioxx1', 'Ioxy1', 'Ioxz1', 'Ioyy1', 'Ioyz1', 'Iozz1', 'Ia1', 'fv1', 'fc1', ...
                  'm2', 'C2x', 'C2y', 'C2z', 'Ioxx2', 'Ioxy2', 'Ioxz2', 'Ioyy2', 'Ioyz2', 'Iozz2', 'Ia2', 'fv2', 'fc2', ...
                  'm3', 'C3x', 'C3y', 'C3z', 'Ioxx3', 'Ioxy3', 'Ioxz3', 'Ioyy3', 'Ioyz3', 'Iozz3', 'Ia3', 'fv3', 'fc3', ...
                  'm4', 'C4x', 'C4y', 'C4z', 'Ioxx4', 'Ioxy4', 'Ioxz4', 'Ioyy4', 'Ioyz4', 'Iozz4', 'Ia4', 'fv4', 'fc4', ...
                  'm5', 'C5x', 'C5y', 'C5z', 'Ioxx5', 'Ioxy5', 'Ioxz5', 'Ioyy5', 'Ioyz5', 'Iozz5', 'Ia5', 'fv5', 'fc5', ...
                  'm6', 'C6x', 'C6y', 'C6z', 'Ioxx6', 'Ioxy6', 'Ioxz6', 'Ioyy6', 'Ioyz6', 'Iozz6', 'Ia6', 'fv6', 'fc6', ...
				  'fe1', 'fe2', 'fe3',  'ne1', 'ne2', 'ne3', ...
				  'g', 'd2', 'd3', 'd5', 'd6', 'a5', 'alp4'}, ...
				  {m1, mc11, mc12, mc13, Io111, Io122, Io133, Io112, Io113, Io123, Ia1, fv1, fc1, ...
				   m2, mc21, mc22, mc23, Io211, Io222, Io233, Io212, Io213, Io223, Ia2, fv2, fc2, ...
				   m3, mc31, mc32, mc33, Io311, Io322, Io333, Io312, Io313, Io323, Ia3, fv3, fc3, ...
				   m4, mc41, mc42, mc43, Io411, Io422, Io433, Io412, Io413, Io423, Ia4, fv4, fc4, ...
				   m5, mc51, mc52, mc53, Io511, Io522, Io533, Io512, Io513, Io523, Ia5, fv5, fc5, ...
				   m6, mc61, mc62, mc63, Io611, Io622, Io633, Io612, Io613, Io623, Ia6, fv6, fc6, ...
				   fe1, fe2, fe3, ne1, ne2, ne3, ...
				   g, d2, d3, d5, d6, a5, alp4}));
end
disp('<INFO> Gravity Torque SUBSTITUTED!!');

%% 摩擦项
F =dynamics_Ffunc(qd, ...
                  fv1, fv2, fv3, fv4, fv5, fv6, ...
                  fc1, fc2, fc3, fc4, fc5, fc6);
FF = sym(zeros(6, 1));
for k = 1:6
    FF(k) = eval(subs(F(k), ...
                 {'m1', 'C1x', 'C1y', 'C1z', 'Ioxx1', 'Ioxy1', 'Ioxz1', 'Ioyy1', 'Ioyz1', 'Iozz1', 'Ia1', 'fv1', 'fc1', ...
                  'm2', 'C2x', 'C2y', 'C2z', 'Ioxx2', 'Ioxy2', 'Ioxz2', 'Ioyy2', 'Ioyz2', 'Iozz2', 'Ia2', 'fv2', 'fc2', ...
                  'm3', 'C3x', 'C3y', 'C3z', 'Ioxx3', 'Ioxy3', 'Ioxz3', 'Ioyy3', 'Ioyz3', 'Iozz3', 'Ia3', 'fv3', 'fc3', ...
                  'm4', 'C4x', 'C4y', 'C4z', 'Ioxx4', 'Ioxy4', 'Ioxz4', 'Ioyy4', 'Ioyz4', 'Iozz4', 'Ia4', 'fv4', 'fc4', ...
                  'm5', 'C5x', 'C5y', 'C5z', 'Ioxx5', 'Ioxy5', 'Ioxz5', 'Ioyy5', 'Ioyz5', 'Iozz5', 'Ia5', 'fv5', 'fc5', ...
                  'm6', 'C6x', 'C6y', 'C6z', 'Ioxx6', 'Ioxy6', 'Ioxz6', 'Ioyy6', 'Ioyz6', 'Iozz6', 'Ia6', 'fv6', 'fc6', ...
...                     'q1', 'q2', 'q3', 'q4', 'q5', 'q6', ...
... 					'qd1', 'qd2', 'qd3', 'qd4', 'qd5', 'qd6', ...
... 					'qdd1', 'qdd2', 'qdd3', 'qdd4', 'qdd5', 'qdd6', ...
				  'fe1', 'fe2', 'fe3',  'ne1', 'ne2', 'ne3', ...
				  'g', 'd2', 'd3', 'd5', 'd6', 'a5', 'alp4'}, ...
				  {m1, mc11, mc12, mc13, Io111, Io122, Io133, Io112, Io113, Io123, Ia1, fv1, fc1, ...
				   m2, mc21, mc22, mc23, Io211, Io222, Io233, Io212, Io213, Io223, Ia2, fv2, fc2, ...
				   m3, mc31, mc32, mc33, Io311, Io322, Io333, Io312, Io313, Io323, Ia3, fv3, fc3, ...
				   m4, mc41, mc42, mc43, Io411, Io422, Io433, Io412, Io413, Io423, Ia4, fv4, fc4, ...
				   m5, mc51, mc52, mc53, Io511, Io522, Io533, Io512, Io513, Io523, Ia5, fv5, fc5, ...
				   m6, mc61, mc62, mc63, Io611, Io622, Io633, Io612, Io613, Io623, Ia6, fv6, fc6, ...
... 					   q1, q2, q3, q4, q5, q6, ...
... 					   qd1, qd2, qd3, qd4, qd5, qd6, ...
... 					   qdd1, qdd2, qdd3, qdd4, qdd5, qdd6, ...
				   fe1, fe2, fe3, ne1, ne2, ne3, ...
				   g, d2, d3, d5, d6, a5, alp4}));
end
disp('<INFO> Friction Torque SUBSTITUTED!!');

% %% coriolis torque
% C = dynamics_gen_coriolis_matrix(TAU);
% CC = zeros(7, 7, 7);
% for k = 1:7
%     CC(:, :, k) = eval(subs(C(:, :, k), ...
%                      {'m1', 'mc11', 'mc12', 'mc13', 'Ic111', 'Ic122', 'Ic133', 'Ic112', 'Ic113', 'Ic123', 'Ia1', 'fv1', 'fc1', ...
%                       'm2', 'mc21', 'mc22', 'mc23', 'Ic211', 'Ic222', 'Ic233', 'Ic212', 'Ic213', 'Ic223', 'Ia2', 'fv2', 'fc2', ...
%                       'm3', 'mc31', 'mc32', 'mc33', 'Ic311', 'Ic322', 'Ic333', 'Ic312', 'Ic313', 'Ic323', 'Ia3', 'fv3', 'fc3', ...
%                       'm4', 'mc41', 'mc42', 'mc43', 'Ic411', 'Ic422', 'Ic433', 'Ic412', 'Ic413', 'Ic423', 'Ia4', 'fv4', 'fc4', ...
%                       'm5', 'mc51', 'mc52', 'mc53', 'Ic511', 'Ic522', 'Ic533', 'Ic512', 'Ic513', 'Ic523', 'Ia5', 'fv5', 'fc5', ...
%                       'm6', 'mc61', 'mc62', 'mc63', 'Ic611', 'Ic622', 'Ic633', 'Ic612', 'Ic613', 'Ic623', 'Ia6', 'fv6', 'fc6', ...
%                       'm7', 'mc71', 'mc72', 'mc73', 'Ic711', 'Ic722', 'Ic733', 'Ic712', 'Ic713', 'Ic723', 'Ia7', 'fv7', 'fc7', ...
%                       's1', 'c1', 's2', 'c2', 's3', 'c3', 's4', 'c4', 's5', 'c5', 's6', 'c6', 's7', 'c7', ...
% 					  'dQ1', 'dQ2', 'dQ3', 'dQ4', 'dQ5', 'dQ6', 'dQ7', ...
% 					  'ddQ1', 'ddQ2', 'ddQ3', 'ddQ4', 'ddQ5', 'ddQ6', 'ddQ7', ...
% 					  'fe1', 'fe2', 'fe3',  'ne1', 'ne2', 'ne3', ...
% 					  'g', 'd1', 'd3', 'd5', 'd7'}, ...
% 					  {m1, mc11, mc12, mc13, Ic111, Ic122, Ic133, Ic112, Ic113, Ic123, Ia1, fv1, fc1, ...
% 					   m2, mc21, mc22, mc23, Ic211, Ic222, Ic233, Ic212, Ic213, Ic223, Ia2, fv2, fc2, ...
% 					   m3, mc31, mc32, mc33, Ic311, Ic322, Ic333, Ic312, Ic313, Ic323, Ia3, fv3, fc3, ...
% 					   m4, mc41, mc42, mc43, Ic411, Ic422, Ic433, Ic412, Ic413, Ic423, Ia4, fv4, fc4, ...
% 					   m5, mc51, mc52, mc53, Ic511, Ic522, Ic533, Ic512, Ic513, Ic523, Ia5, fv5, fc5, ...
% 					   m6, mc61, mc62, mc63, Ic611, Ic622, Ic633, Ic612, Ic613, Ic623, Ia6, fv6, fc6, ...
% 					   m7, mc71, mc72, mc73, Ic711, Ic722, Ic733, Ic712, Ic713, Ic723, Ia7, fv7, fc7, ...
% 					   s1, c1, s2, c2, s3, c3, s4, c4, s5, c5, s6, c6, s7, c7, ...
% 					   dQ1, dQ2, dQ3, dQ4, dQ5, dQ6, dQ7, ...
% 					   ddQ1, ddQ2, ddQ3, ddQ4, ddQ5, ddQ6, ddQ7, ...
% 					   fe1, fe2, fe3, ne1, ne2, ne3, ...
% 					   g, d1, d3, d5, d7}));
% end
% disp('<INFO> Coriolis Matrix SUBSTITUTED!!');

%% 计算各关节最终扭矩

% Control_tau = MM * qdd + GG + FF;
Control_tau = GG + FF;
tt1 = char(vpa(Control_tau(1),4)); tt2 = char(vpa(Control_tau(2),4)); tt3 = char(vpa(Control_tau(3),4)); 
tt4 = char(vpa(Control_tau(4),4)); tt5 = char(vpa(Control_tau(5),4)); tt6 = char(vpa(Control_tau(6),4)); 
fid = fopen('.\data\txt\Control_tau.txt', 'w');
fprintf(fid, ...
    'T1=%s\rT2=%s\rT3=%s\rT4=%s\rT5=%s\rT6=%s\r', ...
    tt1, tt2, tt3, tt4, tt5, tt6);
fclose(fid);

% threshold = 1e-4;
% Control_tau = subs(Control_tau, abs(Control_tau) < threshold, 0);

%% 计算各关节扭矩数值
Control_tau_math = sym(zeros(6, 1));

q = [95.35, 0, 0, -pi/2, pi/2, 0];
qd = [0, 0, 0, 0, 0, 0];
qdd = [0, 0, 0, 0, 0, 0];
q1 = q(1); q2 = q(2); q3 = q(3); q4 = q(4); q5 = q(5); q6 = q(6);
qd1 = qd(1); qd2 = qd(2); qd3 = qd(3); qd4 = qd(4); qd5 = qd(5); qd6 = qd(6);
qdd1 = qdd(1); qdd2 = qdd(2); qdd3 = qdd(3); qdd4 = qdd(4); qdd5 = qdd(5); qdd6 = qdd(6);

for k = 1:6
    Control_tau_math(k) = eval(subs(Control_tau(k), ...
                 {'q1', 'q2', 'q3', 'q4', 'q5', 'q6', ...
 				  'qd1', 'qd2', 'qd3', 'qd4', 'qd5', 'qd6', ...
				  'qdd1', 'qdd2', 'qdd3', 'qdd4', 'qdd5', 'qdd6'}, ...
				  {q1, q2, q3, q4, q5, q6, ...
 				   qd1, qd2, qd3, qd4, qd5, qd6, ...
 				   qdd1, qdd2, qdd3, qdd4, qdd5, qdd6}));
end
% disp('<INFO> Friction Torque SUBSTITUTED!!');
vpa(Control_tau_math(1),4)
vpa(Control_tau_math(2),4)
vpa(Control_tau_math(3),4)
vpa(Control_tau_math(4),4)
vpa(Control_tau_math(5),4)
vpa(Control_tau_math(6),4)



