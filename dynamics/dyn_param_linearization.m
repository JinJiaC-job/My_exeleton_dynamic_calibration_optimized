%% dyn_param_linearization.m

%% PARAMETER
% 每个关节的动力学参数及数量
% {m,mc1,mc2,mc3,Ioxx,Ioyy,Iozz,Ioxy,Ioxz,Ioyz,Ia,fv,fc}
pnum_per_joint = 13;  
% 六关节机械臂总动力学参数的个数
pnum_sum = pnum_per_joint * 6;

%%
Q_ = zeros(pnum_sum, 1);	% 索引矩阵
W = sym(zeros(6, pnum_sum));	% 回归矩阵

for i = 1:pnum_sum
    Q_ = zeros(pnum_sum, 1);
	% （关节-1） 的索引值, e.g. k1 = [0, 1, 2, 3, 4, 5] for 6-joint robot
    k1 = fix((i-1) / pnum_per_joint);
	% （参数-1） 的索引值, e.g. k2 = [0, 1, 2, ..., 12] for standard 13 params	
    k2 = mod(i-1, pnum_per_joint);		
    
    Q_(i) = 1;
    
    if (k2>=1 && k2<=3)		% for k2 = {mc1, mc2, mc3}前三个参数为连杆质心距离，需要将该连杆的质量参数也保留下来。
        Q_(k1 * pnum_per_joint + 1) = 1;   % for m
  
        W(:,i) = subs(tau, ...
		              {'m1', 'C1x', 'C1y', 'C1z', 'Ioxx1', 'Ioxy1', 'Ioxz1', 'Ioyy1', 'Ioyz1', 'Iozz1', 'Ia1', 'fv1', 'fc1', ...
                       'm2', 'C2x', 'C2y', 'C2z', 'Ioxx2', 'Ioxy2', 'Ioxz2', 'Ioyy2', 'Ioyz2', 'Iozz2', 'Ia2', 'fv2', 'fc2', ...
                       'm3', 'C3x', 'C3y', 'C3z', 'Ioxx3', 'Ioxy3', 'Ioxz3', 'Ioyy3', 'Ioyz3', 'Iozz3', 'Ia3', 'fv3', 'fc3', ...
                       'm4', 'C4x', 'C4y', 'C4z', 'Ioxx4', 'Ioxy4', 'Ioxz4', 'Ioyy4', 'Ioyz4', 'Iozz4', 'Ia4', 'fv4', 'fc4', ...
                       'm5', 'C5x', 'C5y', 'C5z', 'Ioxx5', 'Ioxy5', 'Ioxz5', 'Ioyy5', 'Ioyz5', 'Iozz5', 'Ia5', 'fv5', 'fc5', ...
                       'm6', 'C6x', 'C6y', 'C6z', 'Ioxx6', 'Ioxy6', 'Ioxz6', 'Ioyy6', 'Ioyz6', 'Iozz6', 'Ia6', 'fv6', 'fc6'}, ...
					  {Q_(1), Q_(2), Q_(3), Q_(4), Q_(5), Q_(6), Q_(7), Q_(8), Q_(9), Q_(10), Q_(11), Q_(12), Q_(13), ...
					   Q_(14), Q_(15), Q_(16), Q_(17), Q_(18), Q_(19), Q_(20), Q_(21), Q_(22), Q_(23), Q_(24), Q_(25), Q_(26), ...
					   Q_(27), Q_(28), Q_(29), Q_(30), Q_(31), Q_(32), Q_(33), Q_(34), Q_(35), Q_(36), Q_(37), Q_(38), Q_(39), ...
					   Q_(40), Q_(41), Q_(42), Q_(43), Q_(44), Q_(45), Q_(46), Q_(47), Q_(48), Q_(49), Q_(50), Q_(51), Q_(52), ...
					   Q_(53), Q_(54), Q_(55), Q_(56), Q_(57), Q_(58), Q_(59), Q_(60), Q_(61), Q_(62), Q_(63), Q_(64), Q_(65), ...
				       Q_(66), Q_(67), Q_(68), Q_(69), Q_(70), Q_(71), Q_(72), Q_(73), Q_(74), Q_(75), Q_(76), Q_(77), Q_(78)}) ...
			     - W(:, k1 * pnum_per_joint + 1);
    else
        W(:,i) = subs(tau, ...
					  {'m1', 'C1x', 'C1y', 'C1z', 'Ioxx1', 'Ioxy1', 'Ioxz1', 'Ioyy1', 'Ioyz1', 'Iozz1', 'Ia1', 'fv1', 'fc1', ...
                       'm2', 'C2x', 'C2y', 'C2z', 'Ioxx2', 'Ioxy2', 'Ioxz2', 'Ioyy2', 'Ioyz2', 'Iozz2', 'Ia2', 'fv2', 'fc2', ...
                       'm3', 'C3x', 'C3y', 'C3z', 'Ioxx3', 'Ioxy3', 'Ioxz3', 'Ioyy3', 'Ioyz3', 'Iozz3', 'Ia3', 'fv3', 'fc3', ...
                       'm4', 'C4x', 'C4y', 'C4z', 'Ioxx4', 'Ioxy4', 'Ioxz4', 'Ioyy4', 'Ioyz4', 'Iozz4', 'Ia4', 'fv4', 'fc4', ...
                       'm5', 'C5x', 'C5y', 'C5z', 'Ioxx5', 'Ioxy5', 'Ioxz5', 'Ioyy5', 'Ioyz5', 'Iozz5', 'Ia5', 'fv5', 'fc5', ...
                       'm6', 'C6x', 'C6y', 'C6z', 'Ioxx6', 'Ioxy6', 'Ioxz6', 'Ioyy6', 'Ioyz6', 'Iozz6', 'Ia6', 'fv6', 'fc6'}, ...
				      {Q_(1), Q_(2), Q_(3), Q_(4), Q_(5), Q_(6), Q_(7), Q_(8), Q_(9), Q_(10), Q_(11), Q_(12), Q_(13), ...
					   Q_(14), Q_(15), Q_(16), Q_(17), Q_(18), Q_(19), Q_(20), Q_(21), Q_(22), Q_(23), Q_(24), Q_(25), Q_(26), ...
					   Q_(27), Q_(28), Q_(29), Q_(30), Q_(31), Q_(32), Q_(33), Q_(34), Q_(35), Q_(36), Q_(37), Q_(38), Q_(39), ...
					   Q_(40), Q_(41), Q_(42), Q_(43), Q_(44), Q_(45), Q_(46), Q_(47), Q_(48), Q_(49), Q_(50), Q_(51), Q_(52), ...
					   Q_(53), Q_(54), Q_(55), Q_(56), Q_(57), Q_(58), Q_(59), Q_(60), Q_(61), Q_(62), Q_(63), Q_(64), Q_(65), ...
					   Q_(66), Q_(67), Q_(68), Q_(69), Q_(70), Q_(71), Q_(72), Q_(73), Q_(74), Q_(75), Q_(76), Q_(77), Q_(78)});
    end

    disp(['<INFO> Param No.', num2str(i), ' SUBSTITUTED!!']);
end

